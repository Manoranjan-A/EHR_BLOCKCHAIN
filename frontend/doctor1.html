<!doctype html><html><head><meta charset="utf-8"><title>Doctor</title></head><body>
<h2>Doctor Dashboard</h2>

<section><h3>Login</h3>
<form id="loginFormDoc"><input name="email" placeholder="Email"/><br/><input name="password" type="password" placeholder="Password"/><br/><button>Login</button></form>
<pre id="loginDocOut"></pre></section>

<section><h3>Search Patient</h3>
<input id="searchPatient" placeholder="PatientId or name"/><button id="btnSearch">Search</button><pre id="searchOut"></pre></section>

<section><h3>Request Access</h3>
<input id="docId" placeholder="DoctorId"/><input id="reqEhrId" placeholder="EHRId"/><button id="btnReq">Request Access</button><pre id="reqOut"></pre></section>

<section><h3>Fetch Decrypted EHR</h3>
<input id="fetchDocId" placeholder="DoctorId"/><input id="fetchPriv" placeholder="DoctorPrivHex (demo)"/><input id="fetchEhrId" placeholder="EHRId"/><button id="btnFetch">Fetch</button><pre id="fetchOut"></pre></section>

<script>
document.getElementById('loginFormDoc').onsubmit = async (e) => {
  e.preventDefault();

  const body = Object.fromEntries(new FormData(e.target).entries());

  const res = await fetch('/api/login', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(body)
  });

  const j = await res.json();

  document.getElementById('loginDocOut').innerText = j.message || JSON.stringify(j, null, 2);

  if (j.ok) {
    localStorage.setItem('userId', j.id);
    localStorage.setItem('role', j.role);
    document.getElementById('docId').value = j.id;
    document.getElementById('fetchDocId').value = j.id;
  }
};

document.getElementById('btnSearch').onclick = async () => {
  const q = document.getElementById('searchPatient').value.trim();
  const res = await fetch('/api/list-users');
  const j = await res.json();

  const users = (j.users || []).filter(
    u => u.fullName?.toLowerCase().includes(q.toLowerCase()) || u.id === q
  );

  if (users.length === 0) {
    document.getElementById('searchOut').innerText = "No patient found.";
    return;
  }

  const output = users.map(u => `
Full Name: ${u.fullName}
Date of Birth: ${u.dob}
Gender: ${u.gender}
Contact: ${u.contact}
Email: ${u.email}
Address: ${u.address}
EHR IDs: ${u.ehrIds?.length ? u.ehrIds.join(", ") : "None"}
`).join("\n-----------------------\n");

  document.getElementById('searchOut').innerText = output;
};


document.getElementById('btnReq').onclick = async () => {
  const doctorId = document.getElementById('docId').value;
  const ehrId = document.getElementById('reqEhrId').value;

  const res = await fetch('/api/request-access', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ doctorId, ehrId })
  });

  const j = await res.json();

  if (j.err) {
    document.getElementById('reqOut').innerText = j.err; // display error
  } else {
    document.getElementById('reqOut').innerText = j.message; // display success message
  }
};


document.getElementById('btnFetch').onclick = async () => {
  const doctorId = document.getElementById('fetchDocId').value;
  const doctorPrivHex = document.getElementById('fetchPriv').value;
  const ehrId = document.getElementById('fetchEhrId').value;

  const res = await fetch('/api/fetch-ehr', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ doctorId, doctorPrivHex, ehrId })
  });

  const j = await res.json();

  if (res.status === 404) {
    document.getElementById('fetchOut').innerText = 'Error: EHR not found';
    return;
  }
  if (res.status === 403) {
    document.getElementById('fetchOut').innerText =
      j.err === 'patient yet to provide access'
        ? 'Error: Patient has not provided access yet'
        : 'Error: Unauthenticated doctor';
    return;
  }

  if (j.ok) {
    document.getElementById('fetchOut').innerText =
      "EHR request approved. Download starting...";

    const data = j.data;
    const link = document.createElement('a');
    link.href = 'data:application/octet-stream;base64,' + data;
    link.download = j.filename || (ehrId + '.bin');
    document.body.appendChild(link);
    link.click();
    link.remove();
  } else {
    document.getElementById('fetchOut').innerText = "Error fetching EHR";
  }
};


</script>
</body></html>